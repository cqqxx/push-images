name: 同步外网镜像到阿里云

# 触发条件：手动触发、每天凌晨3点（北京时间）和代码push时执行
on:
  workflow_dispatch:  # 手动触发
    #  schedule:
    #- cron: '0 19 * * *'  # UTC 19点 = 北京时间凌晨3点（已启用）
  push:               # 代码push时自动触发
    branches: [ "**" ]  # 监听所有分支的push

jobs:
  mirror-image:
    runs-on: ubuntu-latest
    env:
      # 定义需要同步的镜像列表（多个镜像用空格分隔）
      SOURCE_IMAGES: "apache/kafka:4.0.1"
      # 阿里云仓库信息（建议后续迁移到GitHub Secrets）
      ALI_REGISTRY: "registry.cn-hangzhou.aliyuncs.com"  # 阿里云仓库地址
      ALI_USERNAME: "筱晓爷cq"                           # 登录用户名
      ALI_PASSWORD: "Hj20230701*"                        # 登录密码
      ALI_REPO_PREFIX: "github-pushimages"               # 仓库路径（修改为目标仓库）

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 设置Docker环境
        uses: docker/setup-buildx-action@v3

      - name: 拉取外网镜像
        run: |
          echo "开始拉取镜像列表：${SOURCE_IMAGES}"
          for image in $SOURCE_IMAGES; do
            echo "===== 拉取镜像: $image ====="
            if ! docker pull $image; then
              echo "❌ 拉取镜像 $image 失败"
              exit 1
            fi
            echo "✅ 拉取镜像 $image 成功"
          done

      - name: 镜像打标签（只保留最后一级镜像名）
        run: |
          echo "开始为镜像打标签（目标仓库：${ALI_REGISTRY}/${ALI_REPO_PREFIX}）"

          for image in $SOURCE_IMAGES; do
            # 拆分镜像名和标签
            IMAGE_NAME=$(echo "$image" | cut -d: -f1)
            IMAGE_TAG=$(echo "$image" | cut -d: -f2)
            
            # 提取镜像名的最后一部分（去掉前面的仓库路径，例如从gcr.io/cadvisor/cadvisor中提取cadvisor）
            SHORT_IMAGE_NAME=$(basename "$IMAGE_NAME")

            # 构建目标镜像地址（只保留最后一级镜像名）
            TARGET_IMAGE="${ALI_REGISTRY}/${ALI_REPO_PREFIX}/${SHORT_IMAGE_NAME}:${IMAGE_TAG}"

            echo "===== 标记镜像: $image → $TARGET_IMAGE ====="
            if ! docker tag "$image" "$TARGET_IMAGE"; then
              echo "❌ 标记镜像 $image 失败"
              exit 1
            fi
            echo "✅ 标记镜像 $image 成功"
          done

      - name: 登录阿里云容器仓库
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALI_REGISTRY }}
          username: ${{ env.ALI_USERNAME }}
          password: ${{ env.ALI_PASSWORD }}

      - name: 推送镜像到阿里云
        run: |
          echo "开始推送镜像到阿里云仓库"

          for image in $SOURCE_IMAGES; do
            IMAGE_NAME=$(echo "$image" | cut -d: -f1)
            IMAGE_TAG=$(echo "$image" | cut -d: -f2)
            # 同样提取最后一级镜像名
            SHORT_IMAGE_NAME=$(basename "$IMAGE_NAME")
            TARGET_IMAGE="${ALI_REGISTRY}/${ALI_REPO_PREFIX}/${SHORT_IMAGE_NAME}:${IMAGE_TAG}"

            echo "===== 推送镜像: $TARGET_IMAGE ====="
            if ! docker push "$TARGET_IMAGE"; then
              echo "❌ 推送镜像 $TARGET_IMAGE 失败"
              exit 1
            fi
            echo "✅ 推送镜像 $TARGET_IMAGE 成功"
          done

      - name: 清理本地镜像（节省空间）
        run: |
          echo "开始清理本地镜像"
          docker system prune -af
          echo "✅ 清理完成"
